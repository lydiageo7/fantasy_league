<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Edit Teams</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 30px;
        background-color: #f0f2f5;
      }
      h1 {
        text-align: center;
        margin-bottom: 30px;
      }
      .team-list {
        margin-bottom: 40px;
      }
      .team {
        background: #fff;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      .team img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        margin-right: 15px;
        border-radius: 50%;
      }
      .team-info {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-grow: 1;
      }
      .actions button {
        margin-left: 10px;
        padding: 8px 12px;
        border: none;
        background: #3498db;
        color: white;
        border-radius: 5px;
        cursor: pointer;
      }
      .actions button.delete {
        background: #e74c3c;
      }
      form#addTeamForm, form#editTeamForm {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        max-width: 500px;
        margin: auto;
      }
      form input {
        display: block;
        width: 100%;
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      form button {
        padding: 10px;
        width: 100%;
        background: #2ecc71;
        border: none;
        color: white;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
      }
      /* Edit overlay styles */
      #editOverlay {
        display: none;
        position: fixed;
        top:0;
        left:0;
        right:0;
        bottom:0;
        background: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
      }
      #editFormContainer {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 500px;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <a href="admin-dashboard.html">‚Üê Back to Dashboard</a>
    <h1>Edit Teams</h1>
    <div class="team-list" id="teamList">
      <!-- Teams loaded from the database will appear here -->
    </div>
    <form id="addTeamForm">
      <h2>Add New Team</h2>
      <input type="text" id="newTeamName" placeholder="Team Name" required>
      <input type="number" id="newTeamPlayers" placeholder="Number of Players" required>
      <input type="text" id="newTeamHome" placeholder="Home Field" required>
      <button type="submit">Add Team</button>
    </form>

    <!-- Edit Overlay Form (hidden initially) -->
    <div id="editOverlay">
      <div id="editFormContainer">
        <h2>Edit Team</h2>
        <!-- Note: placeholders will be filled with current values -->
        <form id="editTeamForm">
          <input type="text" id="editTeamName" placeholder="Team Name">
          <input type="number" id="editTeamPlayers" placeholder="Number of Players">
          <input type="text" id="editTeamHome" placeholder="Home Field">
          <button type="submit">Submit Changes</button>
          <button type="button" id="cancelEdit">Cancel</button>
        </form>
      </div>
    </div>

    <script>
      // Load teams from the database instead of localStorage
      async function loadTeams() {
        try {
          const response = await fetch('/api/teams');
          const teams = await response.json();
          displayTeams(teams);
        } catch (error) {
          console.error("Error loading teams: ", error);
        }
      }

      function displayTeams(teams) {
        const teamList = document.getElementById('teamList');
        teamList.innerHTML = '';
        teams.forEach(team => {
          // each team has team_id, team_name, number_of_players, home_field and optionally logo.
          const teamDiv = document.createElement('div');
          teamDiv.className = 'team';
          teamDiv.innerHTML = `
            <div class="team-info">
              ${team.logo ? `<img src="${team.logo}" alt="${team.team_name}">` : ''}
              <span>${team.team_name} | Players: ${team.number_of_players} | Home: ${team.home_field}</span>
            </div>
            <div class="actions">
              <button onclick='openEditForm(${JSON.stringify(team)})'>Edit</button>
              <button class="delete" onclick="deleteTeam(${team.team_id})">Delete</button>
            </div>
          `;
          teamList.appendChild(teamDiv);
        });
      }

      // Add new team
      const addTeamForm = document.getElementById('addTeamForm');
      addTeamForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        const teamName = document.getElementById('newTeamName').value.trim();
        const teamPlayers = document.getElementById('newTeamPlayers').value.trim();
        const teamHome = document.getElementById('newTeamHome').value.trim();
        if (!teamName || !teamPlayers || !teamHome) return;
        try {
          const res = await fetch('/api/teams', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              team_name: teamName,
              number_of_players: teamPlayers,
              home_field: teamHome
            })
          });
          const text = await res.text();
          alert(text);
          loadTeams();
          addTeamForm.reset();
        } catch (error) {
          console.error("Error adding team: ", error);
        }
      });

      // Delete team
      async function deleteTeam(teamId) {
        if(confirm("Are you sure you want to delete this team?")) {
          try {
            const res = await fetch('/api/teams/remove', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ teamId })
            });
            const data = await res.json();
            alert(data.message || data.error);
            loadTeams();
          } catch (error) {
            console.error("Error deleting team: ", error);
          }
        }
      }

      // Edit team
      let currentTeam; // to remember the team being edited
      function openEditForm(team) {
        currentTeam = team;
        // Pre-fill form: if a field is changed, it will be updated, otherwise we keep the current value.
        document.getElementById('editTeamName').value = team.team_name;
        document.getElementById('editTeamPlayers').value = team.number_of_players;
        document.getElementById('editTeamHome').value = team.home_field;
        document.getElementById('editOverlay').style.display = 'flex';
      }

      // Cancel edit
      document.getElementById('cancelEdit').addEventListener('click', function() {
        document.getElementById('editOverlay').style.display = 'none';
      });

      // Submit edited changes
      const editTeamForm = document.getElementById('editTeamForm');
      editTeamForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        // Get values; if empty, fallback to currentTeam's field.
        const newName = document.getElementById('editTeamName').value.trim() || currentTeam.team_name;
        const newPlayers = document.getElementById('editTeamPlayers').value.trim() || currentTeam.number_of_players;
        const newHome = document.getElementById('editTeamHome').value.trim() || currentTeam.home_field;
        try {
          const res = await fetch('/api/teams/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              teamId: currentTeam.team_id,
              newTeamName: newName,
              newNumberOfPlayers: newPlayers,
              newHomeField: newHome
            })
          });
          const data = await res.json();
          alert(data.message || data.error);
          document.getElementById('editOverlay').style.display = 'none';
          loadTeams();
        } catch (error) {
          console.error("Error updating team: ", error);
        }
      });

      // Initial load of teams from database
      loadTeams();
    </script>
  </body>
</html>